<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BD Tek</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css"/>
    <link rel="stylesheet" href="css/tiles.css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.js"></script>
    <script src="http://cdn.firebase.com/js/client/2.3.0/firebase.js"></script>
    <script src="conf.js"></script>
    <script>
    var myFirebaseRef = new Firebase(myFirebaseURL);// Initialize the Firebase DB; make sure you set myFirebaseURL in conf.js
    myFirebaseRef.onAuth(authDataCallback); 
    var userRef;
    var bdRef;
    var authData = myFirebaseRef.getAuth(); // Check authentification status
    var myUserID = "";
    var myUserName = "";
    var htmlForPath = {};


    function initAuthData(authData) {
            myUserID = authData.uid;
            myUserName = authData.google.displayName;

            $("#listPage_header").text("Liste de " + myUserName);

            userRef = myFirebaseRef.child("users").child(authData.uid);
            userRef.once("value", function(snapshot) {
                var data = snapshot.val();
                myUserName = (data["alias"]==null ? authData.google.displayName:data["alias"]);
                $('#prefAlias').val(myUserName);
            });
            userRef.on("child_changed",function(snapshot) {
                if(snapshot.key()=="alias") {
                    myUserName = snapshot.val();
                    $('#prefAlias').val(myUserName);
                }
            });
            
            
            bdRef = myFirebaseRef.child("bd").child(authData.uid);      // contient les bd de l'utilisateur
            bdRef.orderByKey();
            bdRef.on("child_removed", function(snapshot) {
                $('li#' + snapshot.key()).remove();
            });
            bdRef.on("child_added", function(snapshot) {
                handleDisplay(snapshot); 
                        }, function(errorObj) {
                            console.log(errorObj.code);
                            showMessage("Erreur de récupération des données de Firebase : " + errorObj.code);
                        }
            );
            bdRef.on("child_changed", function(snapshot) {
                $('li#' + snapshot.key()).remove();
                handleDisplay(snapshot); 
                        }, function(errorObj) {
                            console.log(errorObj.code);
                            showMessage("Erreur de récupération des données de Firebase : " + errorObj.code);
                        }
            );
    }
    
    function logout() {
        myUserID = "";
        myUserName = "";
        myFirebaseRef.unauth();
        location.reload();
    }
    
    function authDataCallback(authData) {
        //console.log("authDataCallback");
        if (authData) {
            //initAuthData(authData);
            console.log("User " + authData.uid + " is logged in with " + authData.provider);
        } else {
            console.log("User is logged out");
        }
    }

    function handleDisplay(snapshot) {    // add the rows to the list
            var data = snapshot.val();
            var newScoreRow = $("<li id='" + snapshot.key() + "' class='ui-li-has-thumb'>");
            if(data["needLookup"]==0) {
                var newLink = $("<a class='ui-btn ui-btn-icon-right ui-icon-carat-r' href='" + data["detailsURL"] + "' target='_blank'>");
                newLink.append($("<img src='"+(data["imageURL"]==null ? "":data["imageURL"])+"' class='ui-li-thumb'/>"));
                newLink.append($("<h2>"+(data["title"]==null ? snapshot.key():data["title"])+"</h2>"));
                newLink.append($("<p>"+(data["author"]==null ? "inconnu":data["author"])+"</p>"));
                newLink.append($("<p class='ui-li-aside'>"+(data["publisher"]==null ? "?":data["publisher"])+"</p>"));
                newScoreRow.append(newLink);
            } else {
                var newLink = $("<a class='ui-btn ui-btn-icon-right ui-icon-carat-r' href='#' target='_blank'>");
                newLink.append($("<h2>"+snapshot.key()+"</h2>"));
                newLink.append($("<p>en attente</p>"));
                newScoreRow.append(newLink);
            }
            $("#bdTekList").append(newScoreRow);
            htmlForPath[snapshot.key()] = newScoreRow; 
      }

      
      $(document).ready( function() {
        
        if (!authData) { // if user is not authentified, open the auth popup
            console.log("User is not logged in, poping up !");
            myFirebaseRef.authWithOAuthPopup("google", function(error, authData) {
              if (error) {
                console.log("Login Failed!", error);
                showMessage("Erreur d'authentification via Firebase");
              } else {
                initAuthData(authData);
                console.log("Authenticated successfully with payload:", authData.uid);
              }
            });
        } else {
            console.log("Ready, initAuthData");
            initAuthData(authData);
        }

        $("#dialog-modal").popup();
        $('#btnImport').click(function importBarcodes() {
            var separators = ["\n",";",","," "];
            var lines = $('#textarea').val().split(new RegExp(separators.join('|'), 'g')); 
            for(var i = 0;i < lines.length;i++){
                var ean = lines[i].trim().replace(/-/g,"");
                if (!ean) continue;
                bdRef.child(ean).set({
                    needLookup: 1
                });
            }
            $.mobile.changePage( "#listPage", { transition: "slideup", changeHash: true });
        });
        $('#btnSave').click(function savePref() {
            var alias = $('#prefAlias').val().trim(); 
            userRef.child("alias").set(alias);
            $.mobile.changePage( "#listPage", { transition: "slideup", changeHash: true });
        });
    });


    function showMessage(message) {
        $("#dialog-message").text(message);
        $("#dialog-modal").popup("open");
    }

        </script>
</head>
<body>


<!-- Start of first page -->
<div data-role="page" class="my-page" id="listPage" data-theme="b">
    <div data-role="header">
        <h1 id="listPage_header">BDTek</h1>
        <div class="ui-btn-left">
            <a href="#importPage" data-role="button" data-rel="popup" data-position-to="window" data-wrapperels="span" data-mini="true" data-icon="plus" data-iconpos="notext">Importer</a>
            <a href="#configPage" data-role="button" data-rel="popup" data-position-to="window" data-wrapperels="span" data-mini="true" data-icon="gear" data-iconpos="notext">Préférences</a>
        </div>
        <div class="ui-btn-right">
            <a href="#" onclick="logout();" data-role="button" data-wrapperels="span" data-mini="true" data-rel="page" data-icon="delete" data-iconpos="notext">Déconnexion</a>
        </div>
    </div><!-- /header -->

    <div data-role="popup" id="dialog-modal" class="ui-content">
        <a href="#" data-rel="back" data-role="button" data-theme="b" data-icon="delete" data-iconpos="notext"  class="ui-btn-right">Fermer</a>
        <p id="dialog-message"></p>
    </div>

    <div data-role="popup" id="importPage" class="ui-content">
            <a href="#" data-rel="back" data-role="button" data-theme="b" data-icon="delete" data-iconpos="notext"  class="ui-btn-right">Fermer</a>
            <div data-role="header" class="ui-header ui-bar-c">
                 <h1>Saisir une liste d&aposEAN à importer</h1>
            </div>
            <div role="main" class="ui-content">
                <label for="textarea">Saisir une liste d&quot;EAN :</label>
                <textarea cols="40" rows="8" name="textarea" id="textarea"></textarea>
                <button class="ui-shadow ui-btn ui-corner-all" name="btnImport" id="btnImport">Import</button>
            </div><!-- /content -->
    </div>

    <div data-role="popup" id="configPage" class="ui-content">
            <a href="#" data-rel="back" data-role="button" data-theme="b" data-icon="delete" data-iconpos="notext"  class="ui-btn-right">Fermer</a>
            <div data-role="header" class="ui-header ui-bar-c">
                 <h1>Pr&eacute;f&eacute;rences</h1>
            </div>
            <div role="main" class="ui-content">
                <label for="textarea">Alias du compte (sans espace) :</label>
                <input id="prefAlias" value=""/>
                <button class="ui-shadow ui-btn ui-corner-all" name="btnSave" id="btnSave">Enregistrer</button>
            </div><!-- /content -->
    </div>
    <div role="main" class="ui-content">
        <form class="ui-filterable">
          <input id="myFilter" data-type="search">
        </form>
        <ul class="ui-listview ui-listview-inset ui-corner-all ui-shadow" data-role="listview" data-inset="true" data-filter="true" data-input="#myFilter" id="bdTekList" >
            <!-- le contenu est ajouté dynamiquement -->
        </ul>
    </div><!-- /content -->

</div><!-- /page -->

</body>
</html>
